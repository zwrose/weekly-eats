# Worktree Rework Design

**Date:** 2026-02-19
**Status:** Approved

## Problem

The existing worktree setup uses custom bash scripts that create worktrees at `../weekly-eats-worktrees/`, outside the project directory. This caused constant reconsent prompts in Claude Code because every bash command in the worktree was outside the sandbox. Additionally, port assignment via `.env.local` PORT variable was unreliable — worktrees sometimes ended up on wrong ports.

## Decision

Replace custom bash scripts with a superpowers-native approach:
- Worktrees live at `.worktrees/` inside the project (in-sandbox, matches superpowers convention)
- `postinstall` auto-detects worktree context and runs full setup (env generation, DB clone, indexes)
- Dev server explicitly passes `--port` flag instead of relying on `.env.local` PORT loading
- Single cleanup command handles both worktree removal and DB drop

## Design

### Creation Flow

1. `git worktree add .worktrees/<branch> -b <branch>`
2. `cd .worktrees/<branch> && npm install`
3. `postinstall` fires → `scripts/setup-worktree.js`:
   - Detects worktree vs main (checks `git rev-parse --show-toplevel` against `git worktree list`)
   - If main: runs `setup-db` only (existing behavior)
   - If worktree: generates `.env.local` with unique port + DB name → clones main DB → runs `setup-db`
4. Worktree is ready

### Port Assignment

Deterministic from worktree directory name — hash the name to a port in range 3001-3999. Same branch always gets the same port. No scanning of other `.env.local` files needed.

### Dev Server

`npm run dev` uses a wrapper script that reads PORT from `.env.local` and passes it explicitly: `next dev --turbopack --port <N>`. This is more reliable than relying on Next.js to load PORT from `.env.local`.

### Removal Flow

`node scripts/worktree-remove.js <branch>`:
1. Derives DB name from branch name
2. Drops the MongoDB database
3. Runs `git worktree remove .worktrees/<branch>`
4. Runs `git worktree prune`

### What Gets Deleted

- `scripts/worktree-create.sh` — replaced by postinstall auto-detection
- `scripts/worktree-list.sh` — replaced by `git worktree list`
- `scripts/worktree-remove.sh` — replaced by `scripts/worktree-remove.js`

### What Gets Created/Modified

- `scripts/setup-worktree.js` — new: worktree detection + env generation + DB clone
- `scripts/worktree-remove.js` — new: DB drop + git worktree remove
- `package.json` — update postinstall, dev script, add/remove worktree scripts
- `.gitignore` — add `.worktrees/`
- `CLAUDE.md` — update worktree section
- `docs/setup.md` — update worktree section

### Isolation Table

| Resource | Main | Worktree |
|----------|------|----------|
| Port | 3000 | Deterministic 3001-3999 from branch name |
| Database | from `.env.local` | `weekly-eats-<branch>` (cloned from main) |
| `node_modules` | Own copy | Own copy |
| `.env.local` | Manual | Auto-generated by postinstall |
| `.next/` | Own | Own |
