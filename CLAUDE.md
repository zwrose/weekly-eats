# Weekly Eats

Meal planning app built with Next.js 15 (App Router), React 19, MUI v7, MongoDB, and NextAuth.

## Quick Reference

- **Dev server**: `npm run dev` (includes DB setup) or `npm run dev:fast` (skip setup)
- **Tests**: `npm test` (single run) or `npm run test:watch` (watch mode)
- **Full validation**: `npm run check` (lint + test + build — run before pushing)
- **Lint**: `npm run lint`
- **CI**: GitHub Actions runs lint + test with coverage on pushes/PRs to `main`

## Documentation

- **[Architecture](docs/architecture.md)** — system design, features, state management, auth, real-time, database
- **[API Patterns](docs/api-patterns.md)** — REST conventions, auth, validation, error handling, responses
- **[Testing](docs/testing.md)** — Vitest setup, mocking patterns, component/API/hook testing
- **[Setup](docs/setup.md)** — environment, database, dev server, worktrees, CI, migration
- **[Product](docs/product.md)** — product vision, features, UX guidelines, development principles

## Worktree / Multi-Agent Workflow

This project supports running multiple Claude Code agents (or developers) in parallel using git worktrees. Each worktree gets an isolated port, database, and `node_modules`.

### Commands

```bash
# Create a new worktree
git worktree add .worktrees/<branch> -b <branch>
cd .worktrees/<branch> && npm install
# postinstall auto-detects worktree context: generates .env.local, clones DB, creates indexes

# List all worktrees
git worktree list

# Remove a worktree (drops DB + removes worktree)
node scripts/worktree-remove.js <branch-name>
```

### How Isolation Works

| Resource | Main worktree | Each new worktree |
|----------|--------------|-------------------|
| Port | 3000 | Deterministic 3001-3999 (hashed from branch name) |
| Database | from `.env.local` | `weekly-eats-<branch>` (cloned from main) |
| `node_modules` | Own copy | Own copy |
| `.env.local` | Manual | Auto-generated by postinstall |
| `.next/` build cache | Own | Own |

Worktrees live at `.worktrees/<branch>/` inside the project directory.

### Dev Server

`npm run dev` uses a wrapper (`scripts/dev-server.js`) that reads PORT from `.env.local` and passes it explicitly as `next dev --turbopack --port <N>`. This ensures worktrees always start on their assigned port.

### Rules for Parallel Agents

- **Never run two agents on the same worktree/branch** — file edits will collide
- **Always create a worktree** before starting parallel work on a new branch
- **`npm test` and `npm run check` are safe** in any worktree (they use fake DB URIs)
- **Clean up worktrees when done** — `node scripts/worktree-remove.js <branch>` drops the DB and removes the worktree

## Project Structure

```
src/
  app/
    api/          # API routes (Next.js route handlers)
    food-items/   # Feature pages
    meal-plans/
    pantry/
    pending-approval/
    recipes/
    settings/
    shopping-lists/
    user-management/
  components/     # React components
    ui/           # Reusable UI wrappers (DialogTitle, etc.)
    optimized/    # Performance-optimized components
    __tests__/    # Component tests
  lib/
    hooks/        # Custom React hooks (useRecipes, useFoodItems, etc.)
    __tests__/    # Utility tests
    auth.ts       # NextAuth config
    mongodb.ts    # MongoDB connection singleton
    errors.ts     # Centralized error constants
    validation.ts # Input validation helpers
    *-utils.ts    # Domain-specific utilities
    unit-conversion.ts  # Unit conversion using jonahsnider/convert (volume & weight families)
  types/          # TypeScript interfaces
```

## Conventions

### API Routes

- Check auth first: `const session = await getServerSession(authOptions)`
- Return `{ error: AUTH_ERRORS.UNAUTHORIZED }` with 401 if no session
- Admin routes check `user.isAdmin`, return 403 with `AUTH_ERRORS.FORBIDDEN`
- Session user has typed `id`, `isAdmin`, `isApproved` properties — never use `as` casts
- Auth uses JWT strategy; `isAdmin`/`isApproved` are cached in the token (see `src/lib/auth.ts`)
- Use error constants from `@/lib/errors` (never hardcode error strings)
- Log errors with `logError('ContextName', error)`
- Validate ObjectIds with `ObjectId.isValid(id)` before querying
- Always filter user-scoped data by `userId` from the session

### Components

- All interactive components need `"use client"` directive
- Use MUI components and `sx` prop for styling (no CSS files)
- Memoize with `React.memo` where appropriate
- Use custom hooks from `@/lib/hooks/` for data fetching
- Heavy dialog components are dynamically imported with `next/dynamic` (`{ ssr: false }`)
- Each feature route has `loading.tsx` (skeleton) and `error.tsx` (error boundary)

### Tests

- Colocated in `__tests__/` folders next to source files
- Vitest + React Testing Library + MSW for API mocking
- When mocking `@/lib/errors`, include ALL error constant groups the route uses (missing ones cause silent 500s)
- Mock next-auth: `vi.mock('next-auth/next', () => ({ getServerSession: vi.fn() }))`
- Mock MongoDB: `vi.mock('@/lib/mongodb', () => ({ getMongoClient: vi.fn() }))`
- Use `userEvent.setup()` for user interactions (not fireEvent)
- Use `waitFor()` for async assertions

### Database

- MongoDB collections: `mealPlans`, `mealPlanTemplates`, `foodItems`, `recipes`, `recipeUserData`, `pantry`, `users`, `stores`, `storeItemPositions`, `shoppingLists`, `purchaseHistory`
- Access pattern: `const client = await getMongoClient(); const db = client.db();`
- Indexes defined in `src/lib/database-indexes.ts`, applied via `npm run setup-db`

### Code Style

- File naming: PascalCase for components (`MealEditor.tsx`), kebab-case for utilities (`date-utils.ts`)
- TypeScript: prefer interfaces over type aliases, use `unknown` over `any`, avoid type assertions (`as`)
- Exports: named exports only (no default exports)

## Gotchas

- **Build cache**: If `npm run check` fails with MODULE_NOT_FOUND, clear `.next` directory: `rm -rf .next`
- **Dev server after build**: Turbopack dev server crashes with `Cannot find module 'chunks/ssr/[turbopack]_runtime.js'` after `npm run check` or `npm run build`. Fix: `rm -rf .next` then restart dev server.
- **ESM project**: `package.json` has `"type": "module"`. Any standalone `.js` scripts need `.cjs` extension to use `require()`.
- **Dynamic route params**: Next.js 15 params are async — use `{ params }: { params: Promise<{ id: string }> }` then `const { id } = await params;`
- **Test environment**: Tests need fake env vars to avoid real DB connections: `MONGODB_URI='mongodb://localhost:27017/fake' SKIP_DB_SETUP=true`
- **`globals.css`**: Exists in `src/app/` for base resets only. All component styling uses MUI `sx` prop.
- **Fetch mocking**: Use `vi.stubGlobal('fetch', mockFetch)` in `beforeEach` + `vi.unstubAllGlobals()` in `afterEach`. Never assign `global.fetch` at module scope — it leaks across test files in single-fork vitest. Tests using MSW (from `vitest.setup.ts`) should NOT stub `global.fetch`.

## Validation Workflow

- **`npm run check`** runs lint, test:coverage, and build in one command. Run it once — don't re-run individual steps after.
- **Subagent test runs count.** If a subagent already confirmed tests pass, don't re-run the full suite. Only run `npm run check` once at the end as final validation.
- **Investigating test failures:** Run the specific failing test in verbose mode (`npx vitest run path/to/test.tsx`) to confirm it reproduces. If it passes in isolation, it's a flaky test — note it and move on. Don't stash/checkout to test on prior commits (causes merge conflicts on branches with many changes).

## Do Not Edit

- `.env.local` — contains secrets; auto-generated in worktrees by postinstall
- `package-lock.json` — modify only via npm commands
