# Weekly Eats

Meal planning app built with Next.js 15 (App Router), React 19, MUI v7, MongoDB, and NextAuth.

## Quick Reference

- **Dev server**: `npm run dev` (includes DB setup) or `npm run dev:fast` (skip setup)
- **Tests**: `npm test` (single run) or `npm run test:watch` (watch mode)
- **Full validation**: `npm run check` (lint + test + build — run before pushing)
- **Lint**: `npm run lint`
- **CI**: GitHub Actions runs lint + test with coverage on PRs to `main`
- **Branch protection**: `main` is protected — all changes must go through a PR with passing CI. Never push directly to main.

## Documentation

- **[Architecture](docs/architecture.md)** — system design, features, state management, auth, real-time, database
- **[API Patterns](docs/api-patterns.md)** — REST conventions, auth, validation, error handling, responses
- **[Testing](docs/testing.md)** — Vitest setup, mocking patterns, component/API/hook testing
- **[Setup](docs/setup.md)** — environment, database, dev server, worktrees, CI, migration
- **[Product](docs/product.md)** — product vision, features, UX guidelines, development principles

## Worktree / Multi-Agent Workflow

This project supports running multiple Claude Code agents (or developers) in parallel using git worktrees. Each worktree gets an isolated port, database, and `node_modules`.

### Commands

```bash
# Create a new worktree
git worktree add .worktrees/<branch> -b <branch>
cd .worktrees/<branch> && npm install
# postinstall auto-detects worktree context: generates .env.local, clones DB, creates indexes

# List all worktrees
git worktree list

# Remove a worktree (drops DB + removes worktree)
node scripts/worktree-remove.js <branch-name>
```

### How Isolation Works

| Resource             | Main worktree     | Each new worktree                                 |
| -------------------- | ----------------- | ------------------------------------------------- |
| Port                 | 3000              | Deterministic 3001-3999 (hashed from branch name) |
| Database             | from `.env.local` | `weekly-eats-<branch>` (cloned from main)         |
| `node_modules`       | Own copy          | Own copy                                          |
| `.env.local`         | Manual            | Auto-generated by postinstall                     |
| `.next/` build cache | Own               | Own                                               |

Worktrees live at `.worktrees/<branch>/` inside the project directory.

### Dev Server

`npm run dev` uses a wrapper (`scripts/dev-server.js`) that reads PORT from `.env.local` and passes it explicitly as `next dev --turbopack --port <N>`. This ensures worktrees always start on their assigned port.

### Rules for Parallel Agents

- **Never run two agents on the same worktree/branch** — file edits will collide
- **Always create a worktree** before starting parallel work on a new branch
- **`npm test` and `npm run check` are safe** in any worktree (they use fake DB URIs)
- **Clean up worktrees when done** — `node scripts/worktree-remove.js <branch>` drops the DB and removes the worktree

## Project Structure

```
src/
  app/
    api/          # API routes (Next.js route handlers)
    food-items/   # Feature pages
    meal-plans/
    pantry/
    pending-approval/
    recipes/
    settings/
    shopping-lists/
    user-management/
  components/     # React components
    ui/           # Reusable UI wrappers (DialogTitle, etc.)
    optimized/    # Performance-optimized components
    __tests__/    # Component tests
  lib/
    hooks/        # Custom React hooks (useRecipes, useFoodItems, etc.)
    __tests__/    # Utility tests
    auth.ts       # NextAuth config
    mongodb.ts    # MongoDB connection singleton
    errors.ts     # Centralized error constants
    validation.ts # Input validation helpers
    *-utils.ts    # Domain-specific utilities
    unit-conversion.ts  # Unit conversion using jonahsnider/convert (volume & weight families)
  types/          # TypeScript interfaces
```

## Conventions

### API Routes

- Check auth first: `const session = await getServerSession(authOptions)`
- Return `{ error: AUTH_ERRORS.UNAUTHORIZED }` with 401 if no session
- Admin routes check `user.isAdmin`, return 403 with `AUTH_ERRORS.FORBIDDEN`
- Session user has typed `id`, `isAdmin`, `isApproved` properties — never use `as` casts
- Auth uses JWT strategy; `isAdmin`/`isApproved` are cached in the token (see `src/lib/auth.ts`)
- Use error constants from `@/lib/errors` (never hardcode error strings)
- Log errors with `logError('ContextName', error)`
- Validate ObjectIds with `ObjectId.isValid(id)` before querying
- Always filter user-scoped data by `userId` from the session

### Components

- All interactive components need `"use client"` directive
- Use MUI components and `sx` prop for styling (no CSS files)
- Memoize with `React.memo` where appropriate
- Use custom hooks from `@/lib/hooks/` for data fetching
- Heavy dialog components are dynamically imported with `next/dynamic` (`{ ssr: false }`)
- Each feature route has `loading.tsx` (skeleton) and `error.tsx` (error boundary)

### Tests

- Colocated in `__tests__/` folders next to source files
- Vitest + React Testing Library + MSW for API mocking
- When mocking `@/lib/errors`, include ALL error constant groups the route uses (missing ones cause silent 500s)
- Mock next-auth: `vi.mock('next-auth/next', () => ({ getServerSession: vi.fn() }))`
- Mock MongoDB: `vi.mock('@/lib/mongodb', () => ({ getMongoClient: vi.fn() }))`
- Use `userEvent.setup()` for user interactions (not fireEvent)
- Use `waitFor()` for async assertions

### Database

- MongoDB collections: `mealPlans`, `mealPlanTemplates`, `foodItems`, `recipes`, `recipeUserData`, `pantry`, `users`, `stores`, `storeItemPositions`, `shoppingLists`, `purchaseHistory`
- Access pattern: `const client = await getMongoClient(); const db = client.db();`
- Indexes defined in `src/lib/database-indexes.ts`, applied via `npm run setup-db`

### Code Style

- File naming: PascalCase for components (`MealEditor.tsx`), kebab-case for utilities (`date-utils.ts`)
- TypeScript: prefer interfaces over type aliases, use `unknown` over `any`, avoid type assertions (`as`)
- Exports: named exports only (no default exports)

## Gotchas

- **Build cache**: If `npm run check` fails with MODULE_NOT_FOUND, clear `.next` directory: `npm run clean`
- **Dev server after build**: Turbopack dev server crashes with `Cannot find module 'chunks/ssr/[turbopack]_runtime.js'` after `npm run check` or `npm run build`. Fix: `npm run clean` then restart dev server.
- **ESM project**: `package.json` has `"type": "module"`. Any standalone `.js` scripts need `.cjs` extension to use `require()`.
- **Dynamic route params**: Next.js 15 params are async — use `{ params }: { params: Promise<{ id: string }> }` then `const { id } = await params;`
- **Test environment**: Tests need fake env vars to avoid real DB connections: `MONGODB_URI='mongodb://localhost:27017/fake' SKIP_DB_SETUP=true`
- **`globals.css`**: Exists in `src/app/` for base resets only. All component styling uses MUI `sx` prop.
- **Fetch mocking**: Use `vi.stubGlobal('fetch', mockFetch)` in `beforeEach` + `vi.unstubAllGlobals()` in `afterEach`. Never assign `global.fetch` at module scope — it leaks across test files in single-fork vitest. Tests using MSW (from `vitest.setup.ts`) should NOT stub `global.fetch`.
- **Windows environment**: This project may be developed on Windows. If a command fails with `ENOENT` or `command not found`, the issue is likely Windows-specific (e.g., `spawn('npx', ...)` needs `shell: true` or `.cmd` extension on Windows). Work with the user to troubleshoot cross-platform differences.
- **MongoDB CLI tools on Windows**: `mongodump`/`mongorestore` are not bundled with MongoDB — install separately via [MongoDB Database Tools](https://www.mongodb.com/try/download/database-tools). Without them, worktree DB clone is skipped during `npm install`. Fallback: use the Node.js MongoDB driver to copy collections between databases.
- **Preview vs Chrome extension**: The Claude Preview tool only supports localhost URLs — external redirects (e.g., Google OAuth to `accounts.google.com`) are blocked. Prefer the **Claude in Chrome** extension for testing auth flows and any interaction that involves external domains. Use Preview for quick layout/styling checks only.

## Claude Code Automations

### Hooks (`.claude/hooks/`)

PostToolUse hooks fire on every Edit/Write in this order:

1. **format-on-edit** — runs Prettier on the edited file
2. **lint-on-edit** — runs ESLint on `.ts/.tsx` files
3. **typecheck-on-edit** — runs `tsc --noEmit` on the project

PreToolUse hooks block edits to protected files:

- **block-env-edit** — prevents editing `.env` files
- **block-lock-edit** — prevents editing `package-lock.json`

### Skills (`.claude/skills/`)

| Skill            | Invocation   | Purpose                                          |
| ---------------- | ------------ | ------------------------------------------------ |
| `/check`         | User or auto | Run full lint + test + build validation          |
| `/gen-test`      | User or auto | Generate tests following project conventions     |
| `/new-api-route` | User or auto | Scaffold API route with auth/validation template |
| `/new-component` | User or auto | Scaffold component + test file from templates    |
| `/review-pr`     | User or auto | Orchestrate multi-agent PR review                |

### Agents (`.claude/agents/`)

| Agent               | Focus                                                                            |
| ------------------- | -------------------------------------------------------------------------------- |
| `code-reviewer`     | Project convention adherence (exports, TypeScript, error handling, API patterns) |
| `test-reviewer`     | Test quality (mock patterns, fetch mocking, cleanup, coverage)                   |
| `security-reviewer` | Auth bypass, MongoDB injection, IDOR, input validation                           |
| `a11y-reviewer`     | ARIA, keyboard nav, focus management, contrast, semantic HTML                    |

## Git Workflow

- **Never push directly to `main`** — branch protection requires a PR with passing CI (`test` job).
- **Always work on a feature branch** — create a branch, make changes, open a PR, merge after CI passes.
- **Prefer squash merges** for clean history.
- **Clean up branches after merge** — delete remote and local branches, remove worktrees if used.

## Validation Workflow

- **`npm run check`** runs lint, test:coverage, and build in one command. Run it once — don't re-run individual steps after.
- **Subagent test runs count.** If a subagent already confirmed tests pass, don't re-run the full suite. Only run `npm run check` once at the end as final validation.
- **Investigating test failures:** Run the specific failing test in verbose mode (`npx vitest run path/to/test.tsx`) to confirm it reproduces. Don't stash/checkout to test on prior commits (causes merge conflicts on branches with many changes).
- **Flaky tests must be fixed.** If a test passes in isolation but fails in the full suite, it has a real problem (timing, shared state, etc.) — fix it before moving on. Flaky tests block CI and merging.

## Verification (UI Changes)

- **Always use Chrome / "Claude in Chrome" MCP tools** for verifying UI changes — this app requires Google OAuth login, so Preview tools cannot access authenticated pages.
- Preview tools (`preview_*`) may only be used for unauthenticated pages (landing page, sign-in screen).
- For authenticated pages: use `mcp__Claude_in_Chrome__*` tools (screenshot, read_page, find, computer, etc.) to verify changes in a browser where the user is already signed in.

## Windows Development

- The project supports **native Windows** (PowerShell, cmd.exe) in addition to Unix/macOS.
- All npm scripts use `cross-env` for environment variables — no Unix-only `VAR=x cmd` syntax.
- All Node.js scripts use cross-platform APIs (`path.join`, `fs.rmSync`, `os.tmpdir`) — no `rm -rf`, `mktemp`, or `which`.
- If adding new scripts: use Node.js built-in APIs for file operations, and `process.platform === 'win32'` for platform-specific command names.

## Do Not Edit

- `.env.local` — contains secrets; auto-generated in worktrees by postinstall
- `package-lock.json` — modify only via npm commands
